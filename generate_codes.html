<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD Helper - 激活码生成器 (本地版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-blue-600 p-6 text-white text-center">
            <h1 class="text-2xl font-bold">激活码生成器</h1>
            <p class="text-blue-100 text-sm mt-1">本地安全运行，无需联网</p>
        </div>

        <div class="p-8 space-y-6">
            
            <!-- Secret Key Input -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Secret Key (加密密钥)</label>
                <input type="text" id="secretKey" value="adhd-helper-secret-2025" 
                    class="w-full bg-gray-50 border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all placeholder-gray-400"
                    placeholder="请输入与 .env.local 一致的密钥">
                <p class="text-xs text-gray-500 mt-1">必须与服务器配置的 CODE_SECRET 完全一致</p>
            </div>

            <!-- Count Input -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">生成数量</label>
                    <input type="number" id="count" value="1" min="1" max="100"
                        class="w-full bg-gray-50 border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">类型</label>
                    <select id="type" class="w-full bg-gray-50 border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="10-chats">10次对话</option>
                        <option value="3-chats">3次对话</option>
                    </select>
                </div>
            </div>

            <!-- Action Button -->
            <button onclick="generateCodes()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all active:scale-95">
                立即生成
            </button>

            <!-- Results -->
            <div id="resultArea" class="hidden animate-fade-in-up">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold text-gray-800">生成结果</h3>
                    <button onclick="copyAll()" class="text-xs text-blue-600 hover:text-blue-800 font-medium hover:underline">复制全部</button>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 max-h-60 overflow-y-auto custom-scrollbar">
                    <pre id="codeOutput" class="text-green-400 font-mono text-sm leading-relaxed whitespace-pre-wrap break-all"></pre>
                </div>
            </div>

        </div>
    </div>

    <script>
        async function hmacSha256(key, message) {
            const enc = new TextEncoder();
            const cryptoKey = await crypto.subtle.importKey(
                "raw", enc.encode(key), { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
            );
            const signature = await crypto.subtle.sign("HMAC", cryptoKey, enc.encode(message));
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function generateCodes() {
            const secret = document.getElementById('secretKey').value;
            const count = parseInt(document.getElementById('count').value);
            const type = document.getElementById('type').value;
            const output = document.getElementById('codeOutput');
            const resultArea = document.getElementById('resultArea');

            if (!secret) {
                alert("请输入 Secret Key");
                return;
            }

            const codes = [];
            for (let i = 0; i < count; i++) {
                // Logic matching lib/codes.ts
                // 1. Payload: TYPE.TIMESTAMP
                // Note: Adding loop index to timestamp to ensure uniqueness if generated in same millisecond
                const timestamp = Date.now() + i; 
                const payload = `${type}.${timestamp}`;
                
                // 2. Signature: HMAC-SHA256(SECRET, payload) -> Hex -> First 8 chars
                const fullSig = await hmacSha256(secret, payload);
                const sig = fullSig.substring(0, 8);
                
                // 3. Final: Base64(payload.sig)
                const raw = `${payload}.${sig}`;
                // Usage of btoa compatible with Buffer.from(...).toString('base64') for ASCII
                let code = btoa(raw);
                
                // 4. Remove padding '='
                code = code.replace(/=/g, '');
                
                codes.push(code);
            }

            output.textContent = codes.join('\n');
            resultArea.classList.remove('hidden');
        }

        function copyAll() {
            const text = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('已复制到剪贴板！');
            });
        }
    </script>
</body>
</html>
